---
title: "GBM_survival_cox"
output: html_document
date: '2022-08-21'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r library}
library(dplyr)
library(tidyr)
library(ggplot2)
library(survival)
library(ggfortify)
library(maxstat)
library(survminer)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
root_dir = '/mnt/hdd/kschoi/GBM/CleanData_cks/DL_features/best'
setwd(root_dir)
list.dirs()
len_list = length(list.dirs())
len_list

# label_dir = '/mnt/hdd/kschoi/GBM/CleanData_cks/DL_features/best/LH_seq1_b16_mri_DenseNet_aug_s9876543_b16_spl0.8_e25_all_long'
label_dir = file.path(root_dir, 'LH_seq1_b16_mri_DenseNet_aug_s123456_b16_spl0.8_e25_all_long')
# label_dir = file.path(root_dir, 'DH_seq2_b16_mri_DenseNet_aug_s9876543_b16_spl0.8_e50_all_long') # BEST
# label_dir = file.path(root_dir, basename(list.dirs()[[16]])) # 2부터 시작: 16 only working
label_dir
```

```{r}
train_csv_path = file.path(label_dir,'SNUH_merged_all_long_prediction_and_label_selected.csv')
test_csv_path = file.path(label_dir,'SNUH_temporal_all_long_prediction_and_label_selected.csv')
# test_csv_path = file.path(label_dir,'severance_all_long_prediction_and_label_selected.csv')

df = read.csv(train_csv_path)
test_df = read.csv(test_csv_path)

chr2factor <- function(df){
  df[sapply(df, is.character)] <- lapply(df[sapply(df, is.character)], as.factor)
  return (df)
}

df <- chr2factor(df)
test_df <- chr2factor(test_df)

print(nrow(df))
print(nrow(test_df))
```

``` {r}

preproc <- function(df){
  df = df %>% mutate(
  EOR = ifelse(EOR %in% c('biopsy', 'partial', 'subtotal'), 'nontotal', 'total'), # 
  EOR = factor(EOR),
  MRI_avg_early = # 1 * MRI1+
                  # 1 * MRI2+
                  1 * MRI3+
                  1 * MRI4
                  # 1 * MRI9
  )
return (df)
}

df <- preproc(df)
test_df <- preproc(test_df)
test_df$MRI_avg_early
```
```{r}

get_cutoff_MRI <- function(df, MRI_feature){
  
  MRI_feature_stat <- maxstat.test(Surv(duration, event) ~ MRI_feature, data=df,smethod='LogRank', pmethod='exactGauss', abseps=0.01)
  plot(MRI_feature_stat)
  
  MRI_feature_cutoff <- MRI_feature_stat$estimate
  
  return (MRI_feature_cutoff)
}
  
cutoff <- get_cutoff_MRI(df, df$MRI_avg_early) # ERROR:그냥 MRI3라 쓰면 안되고 df$MRI3로 해야 함
cutoff

test_cutoff <- get_cutoff_MRI(test_df, test_df$MRI_avg_early)
test_cutoff

convert_MRI_bin <- function(df, MRI_feature, cutoff){
    df = df %>% mutate(
    MRI_feature_group = ifelse(MRI_feature<=cutoff, 0, 1),
    MRI_feature_group = factor(MRI_feature_group)
  )
    return (df)
}
  
df <- convert_MRI_bin(df, df$MRI_avg_early, cutoff) # df$MRI_avg_early

```

```{r}
test_df$MRI_avg_early
test_df <- convert_MRI_bin(test_df, test_df$MRI_avg_early, cutoff)
test_df$MRI_feature_group
```


```{r}
cox <- coxph(Surv(duration, event) ~ age + sex + MGMT + EOR, data=test_df, x = TRUE)
summary(cox)
```
```{r}
cox <- coxph(Surv(duration, event) ~ MRI_avg_early, data=test_df, x = TRUE)
summary(cox)
```

```{r}
cox <- coxph(Surv(duration, event) ~ MRI_feature_group, data=test_df, x = TRUE)
summary(cox)
```
```{r}
cox <- coxph(Surv(duration, event) ~ sex + age + IDH + MGMT + EOR + MRI_avg_early, data=df, x = TRUE)
summary(cox)
```

```{r}
cox <- coxph(Surv(duration, event) ~ sex + age + IDH + MGMT + EOR + MRI_feature_group, data=df, x = TRUE)
summary(cox)
```

```{r}
cox <- coxph(Surv(duration, event) ~ sex + age + IDH + MGMT + EOR + MRI_avg_early, data=test_df, x = TRUE)
summary(cox)
```

```{r}
cox <- coxph(Surv(duration, event) ~ sex + age + IDH + MGMT + EOR + MRI_feature_group, data=test_df, x = TRUE)
summary(cox)
```
